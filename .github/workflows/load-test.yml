name: Load Testing

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * 1' # Weekly on Monday at 2 AM UTC

jobs:
  load-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_DB: testapp
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup database
        run: |
          npm run migrate
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/testapp

      - name: Install k6
        run: |
          sudo apt update
          sudo apt install -y wget
          wget https://github.com/grafana/k6/releases/download/v0.49.0/k6-v0.49.0-linux-amd64.tar.gz
          tar -xzf k6-v0.49.0-linux-amd64.tar.gz
          sudo mv k6-v0.49.0-linux-amd64/k6 /usr/local/bin/k6

      - name: Start application
        run: |
          npm run server &
          sleep 10
        env:
          DATABASE_URL: postgresql://postgres@localhost:5432/testapp
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          JWT_SECRET: test-jwt-secret

      - name: Run load tests
        run: |
          k6 run --out json=load-test-results.json load-test.js

      - name: Upload load test results
        uses: actions/upload-artifact@v4
        with:
          name: load-test-results
          path: load-test-results.json
